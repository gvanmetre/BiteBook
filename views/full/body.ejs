<div class="recontainer mid fullcontainer" style="max-width: 700px; margin: 20px auto; flex-direction: column; padding: 20px;">
  
  <h2 style="text-align: center; margin-top:0px; margin-bottom: 15px;"><%= recipe.name %></h2>

  <% if (recipe.image) { %>
    <div style="width: 100%; aspect-ratio: 1 / 1; overflow: hidden; border-radius: 12px; margin-bottom: 15px;">
      <img 
        src="<%= recipe.image %>" 
        alt="<%= recipe.name %>" 
        style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"
      >
    </div>
  <% } else { %>
    <div style="width: 100%; aspect-ratio: 1 / 1; border-radius: 12px; background-color: #303030; display: flex; align-items: center; justify-content: center; color: #aaa; font-style: italic; margin-bottom: 15px;">
      No image available
    </div>
  <% } %>

  <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
    <% if (recipe.creator.avatar) { %>
      <img src="<%= recipe.creator.avatar %>" alt="<%= recipe.creator.username %>" 
           style="width:32px; height:32px; border-radius:20%; object-fit:cover;">
    <% } else { %>
      <div style="width:32px; height:32px; background:#333; color:#aaa; display:flex; 
                  justify-content:center; align-items:center; border-radius:20%; font-size:0.7em;">
        N/A
      </div>
    <% } %>

  <p style="text-align: center; color: #ccc; margin-bottom: 20px; display:flex; align-items:center; justify-content:center; gap:10px;">  
    <a href="/user/<%= recipe.creator._id %>" style="color:#4da3ff; text-decoration:none;"><%= recipe.creator.username %></a>
    On: <%= recipe.createdAt.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }) %>
  </p>
</div>
  <div style="line-height: 1.6; margin-bottom:0px; text-align: left;">
    <p><b>Type:</b> <%= recipe.type %></p>
    <p><b>Calories:</b> <%= recipe.calories %></p>
    <p><b>Fat:</b> <%= recipe.fat %>g</p>
    <p><b>Carbs:</b> <%= recipe.carbs %>g</p>
    <p><b>Protein:</b> <%= recipe.protein %>g</p>
    <% if(recipe.sodium) { %>
      <p><b>Sodium:</b> <%= recipe.sodium %>mg</p>
    <% } %>
    <p><b>Public:</b> <%= recipe.public ? 'Yes' : 'No' %></p>

    <h3 style="margin-top: 20px;">Ingredients</h3>
    <ul style="margin-left: 20px;">
      <% recipe.ingredients.forEach(ingredient => { %>
        <li><%= ingredient %></li>
      <% }); %>
    </ul>

    <h3 style="margin-top: 20px;">Instructions</h3>
    <p style="margin-bottom:0px;"><%= recipe.instructions %></p>
  </div>

  <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
    <% if(recipe.creator._id.toString() === user._id.toString()) { %>
      <button class="btn blue" onclick="location.href='/recipes/edit/<%= recipe._id %>'">Edit</button>
      <button class="btn red" onclick="if(confirm('Are you sure you want to delete this recipe?')) { location.href='/recipes/delete/<%= recipe._id %>'; }">Delete</button>
    <% } %>
    <button class="btn green" onclick="location.href='/recipes'">Back</button>

    <button 
      id="likeBtn"
      class="btn"
      style="background-color: <%= recipe.likes.includes(user._id.toString()) ? '#ff4d4d' : '#555' %>; border-radius: 8px; cursor: pointer;
-"
      onclick="toggleLike('<%= recipe._id %>')">
      ‚ù§Ô∏è <span id="likeCount"><%= recipe.likes.length %></span>
    </button>
  </div>

  <div id="comments-section" style="margin-top: 10px; width: 100%;">
    <h3>Comments (<%= recipe.comments.length %>)</h3>
    <div style="margin-bottom: 15px;">
      <textarea 
        id="comment-input" 
        placeholder="Add a comment (max 500 chars)..." 
        class="default-textarea" 
        style="width:100%; resize: vertical;" 
        maxlength="500"></textarea>
      <button class="btn green" style="margin-top:5px;" onclick="addComment('<%= recipe._id %>')">Post Comment</button>
    </div>

    <div id="comments-container">
      <% recipe.comments.forEach(comment => { %>
        <div class="comment" id="comment-<%= comment._id %>"
          style="margin-bottom:10px; padding:10px; background:#505050; border-radius:8px; position: relative; display:flex; gap:10px; align-items:flex-start;">

          <img src="<%= comment.user.avatar %>" alt="<%= comment.user.username %>" style="width:64px; height:64px; border-radius:20%; object-fit:cover; margin-top:4px;">

          <div style="flex:1; margin:5px;">
            <b><a href="/user/<%= comment.user._id %>" style="color:#4da3ff; text-decoration:none;"><%= comment.user.username %></a></b>
            <span style="color:#aaa; font-size:0.8em;"> - <%= new Date(comment.createdAt).toLocaleString() %></span>
            <p style="width:80%;" id="comment-text-<%= comment._id %>"><%= comment.text %></p>
          </div>

          <div style="position:absolute; top:10px; right:10px; display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
  
            <button id="comment-like-<%= comment._id %>" class="btn"
                    style="width:85px; height:40px; display:flex; align-items:center; justify-content:center; font-size:16px; background-color:<%= comment.likes.some(u => u._id.toString() === user._id.toString()) ? '#ff4d4d' : '#555' %>;"
                    onclick="toggleCommentLike('<%= recipe._id %>', '<%= comment._id %>')">
              ‚ù§Ô∏è <span id="comment-like-count-<%= comment._id %>" style="margin-left:4px;"><%= comment.likes.length %></span>
            </button>
          
            <div style="display:flex; gap:5px;">
              <% if(comment.user._id.toString() === user._id.toString() || user.isAdmin) { %>
                <button onclick="editComment('<%= comment._id %>')" class="btn blue" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;">‚úé</button>
                <button onclick="deleteComment('<%= comment._id %>')" class="btn red" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;">üóëÔ∏è</button>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</div>

<script>
  async function toggleLike(recipeId) {
    try {
      const res = await fetch(`/recipes/${recipeId}/like`, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      });
  
      const data = await res.json();
  
      // Update UI
      const btn = document.getElementById("likeBtn");
      const countSpan = document.getElementById("likeCount");
  
      countSpan.innerText = data.likeCount;
  
      if (data.liked) {
        btn.style.backgroundColor = "#ff4d4d";
        btn.innerHTML = `‚ù§Ô∏è <span id="likeCount">${data.likeCount}</span>`;
      } else {
        btn.style.backgroundColor = "#555";
        btn.innerHTML = `‚ù§Ô∏è <span id="likeCount">${data.likeCount}</span>`;
      }
  
    } catch (err) {
      console.error("Like error:", err);
    }
  }
  </script>
 <script>
  const RECIPE_ID = '<%= recipe._id %>';

  async function addComment(recipeId = RECIPE_ID) {
    const input = document.getElementById('comment-input');
    let text = input.value.trim();
    
    if(!text) return;
    if(text.length > 500) {
      alert("Comment too long. Max 500 characters.");
      return;
    }

    try {
      const res = await fetch(`/recipes/${recipeId}/comments`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest' },
        body: JSON.stringify({ text })
      });

      const data = await res.json();
      if(!data.success) return alert('Failed to post comment');

      input.value = '';

      const c = data.comment;
      const container = document.getElementById('comments-container');

      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment';
      commentDiv.id = `comment-${c._id}`;
      commentDiv.style = "margin-bottom:10px; padding:10px; background:#505050; border-radius:8px; position:relative; display:flex; gap:10px; align-items:flex-start;";

      commentDiv.innerHTML = `
        <img src="${c.user.avatar}" alt="${c.user.username}" style="width:64px; height:64px; border-radius:20%; object-fit:cover; margin-top:4px;">
        <div style="flex:1; margin:5px;">
          <b><a href="/user/${c.user._id}" style="color:#4da3ff; text-decoration:none;">${c.user.username}</a></b>
          <span style="color:#aaa; font-size:0.8em;"> - ${new Date(c.createdAt).toLocaleString()}</span>
          <p style="width:80%;" id="comment-text-${c._id}">${c.text}</p>
        </div>
        <div style="position:absolute; top:10px; right:10px; display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
          <button id="comment-like-${c._id}" class="btn"
                  style="width:85px; height:40px; display:flex; align-items:center; justify-content:center; font-size:16px; background-color:#555;"
                  onclick="toggleCommentLike('${recipeId}', '${c._id}')">
            ‚ù§Ô∏è <span id="comment-like-count-${c._id}" style="margin-left:4px;">0</span>
          </button>
          <div style="display:flex; gap:5px;">
            <button onclick="editComment('${c._id}')" class="btn blue" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;">‚úé</button>
            <button onclick="deleteComment('${c._id}')" class="btn red" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;">üóëÔ∏è</button>
          </div>
        </div>
      `;

      container.appendChild(commentDiv);
      const title = document.querySelector("#comments-section h3");
      title.textContent = `Comments (${container.children.length})`;
    } catch(err) {
      console.error('Comment error:', err);
    }
  }
  
  function editComment(commentId) {
    const p = document.getElementById(`comment-text-${commentId}`);
    const oldText = p.textContent;
    const newText = prompt("Edit your comment:", oldText);
    if (newText === null || newText.trim() === "") return;
  
    const recipeId = window.location.pathname.split('/')[2];
  
    fetch(`/recipes/${recipeId}/comments/${commentId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify({ text: newText })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        p.textContent = newText;
      }
    });
  }
  
  function deleteComment(commentId) {
    if (!confirm("Delete this comment?")) return;
  
    const recipeId = window.location.pathname.split('/')[2];
  
    fetch(`/recipes/${recipeId}/comments/${commentId}`, {
      method: 'DELETE',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`comment-${commentId}`).remove();
  
        // Update comment counter
        const container = document.getElementById('comments-container');
        const newCount = container.children.length;
        const title = document.querySelector("#comments-section h3");
        title.textContent = `Comments (${newCount})`;
      }
    });
  }
  </script>
  <script>
    async function toggleCommentLike(recipeId, commentId) {
      try {
        const res = await fetch(`/recipes/${recipeId}/comments/${commentId}/like`, { 
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        
        const data = await res.json();
        if (!data.success) return;

        const btn = document.getElementById(`comment-like-${commentId}`);
        const countSpan = document.getElementById(`comment-like-count-${commentId}`);

        countSpan.textContent = data.likeCount;

        btn.style.backgroundColor = data.liked ? '#ff4d4d' : '#555';

      } catch (err) {
        console.error("Comment like error:", err);
      }
    }
  </script>